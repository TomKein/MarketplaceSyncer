# Механики Легаси Проекта (Legacy Mechanics)

Анализ бизнес-логики в `Legacy\Selen\Base\Class365API.cs`.

## 1. Синхронизация Товаров (Sync)
### Full Sync (`GoFullSync`)
*   Скачивает **всю** базу товаров.
*   Использует пагинацию.
*   Фильтрует: `archive=0`, `type=1` (товары), `with_remains=1`, `with_prices=1`.
*   Сохраняет результат локально в `bus.json`.

### Lite Sync (`GoLiteSync`)
*   Скачивает только **изменения** (`updated[from]`) и **изменения остатков/цен** (`updated_remains_prices[from]`) с момента последнего сканирования.
*   Обновляет локальный кэш `_bus`.
*   Если изменений слишком много (>250) или файл кэша устарел — инициирует полный рескан.

## 2. Управление Группами
### Авто-перемещение (`GroupsMoveAsync`)
*   Ищет товары с `group_id = 1` (корень/без группы).
*   Автоматически перемещает их в группу с названием, содержащим "Заказы".

### Очистка ссылок ("Разборка")
*   Если группа товара содержит "РАЗБОРКА" (или товар "Копия", или пустые остатки), ссылки на маркетплейсы (Drom, VK, Ozon, WB - кастомные поля) удаляются.

## 3. Обработка Артикулов и Имен (`PartsCorrection`, `CheckGrammar`)
*   **Артикулы**: Удаление пробелов, точек, нижних подчеркиваний, приведение к верхнему регистру.
*   **Имена/Описания**:
    *   Удаление упоминаний Viber/Вайбер.
    *   Типографика: пробелы после запятых, скобок, перед "№", ":", "г" (год).
    *   Удаление HTML тегов (`<br>`, `&nbsp;`).
    *   Замена кавычек.
*   **Дубли**: Поиск товаров с похожими именами. Если дубль не на остатках, он переименовывается (добавляется `.` или `'`).

## 4. Резервирование (`MakeReserve`)
*   Создает **Заказ покупателя** (`customerorders`) со статусом "Маркетплейсы".
*   Создает связанный **Резерв** (`reservations`).
*   Если товар уже зарезервирован/в заказе — пропускает.

## 5. Коррекция Цен в Реализациях (`CheckRealisationsAsync`)
*   Проверяет реализации со статусами маркетплейсов (Яндекс, Озон, WB).
*   Сверяет цену в реализации с текущей ценой товара.
*   **Логика**: Цена в реализации принудительно устанавливается как `0.75 * ТекущаяЦенаТовара`.
*   Обновляет сумму строки соответственно.

## 6. Очистка и Архивация
### Очистка Фото (`PhotoClearAsync`)
*   Удаляет фото у товаров, которые:
    *   Без остатка и резерва.
    *   Обновлены давно (логика зависит от "новизны" товара и даты последней реализации).
*   Использует запрос к `realizationgoods` для проверки даты последней продажи.

### Архивация (`ArchivateAsync`)
*   Перемещает товары в архив (`archive=1`), если:
    *   Нет фото, нет остатка, нет резерва.
    *   Не обновлялись 3 года (или 1 день для старых товаров без признака New).

## 7. Фикс Цен (`UpdatePrices`)
*   *Костыль*: Проходит по прайс-листам, меняет цену товара на +0.01, затем возвращает обратно. Вероятно, чтобы триггернуть события обновления на стороне Business.ru или связанных систем.
