# Архитектура синхронизации с Business.ru

## Обзор

Система синхронизации работает в двух режимах:

| Режим | Описание |
|-------|----------|
| **Полная (Full)** | Загрузка всех данных с нуля. Выполняется в ночное окно. |
| **Инкрементальная** | Загрузка только изменённых данных по интервалам. |

---

## Логика главного цикла

```
СТАРТ:
├── Первый запуск (Full_CompletedAt = null)? → Полная сразу
├── ForceFullSync = true? → Полная сразу
├── Незавершённая полная + ночное окно? → Продолжить
├── Нужна полная (> FullSyncMaxAge) + ночное окно? → Начать
└── Иначе → Инкрементальная

НОЧНОЕ ОКНО (01:00-05:00 МСК):
├── Полная синхронизация с прерыванием в конце окна
└── Незавершённая продолжится следующей ночью

ВНЕ НОЧНОГО ОКНА:
└── Только инкрементальная синхронизация
```

---

## Полная синхронизация (4 шага)

1. **Справочники** — страны, валюты, единицы измерения, группы товаров
2. **Атрибуты** — определения атрибутов и их значения
3. **Товары + Изображения** — постраничная загрузка с чекпоинтами, изображения скачиваются inline
4. **Отношения** — связи товаров с единицами измерения

> **Crash Recovery**: при перезапуске синхронизация продолжается с последнего чекпоинта.

---

## Изображения

Изображения обрабатываются **inline** при синхронизации товаров:
- Данные берутся из `apiGood.Images[]` (не отдельный API-запрос)
- Иммутабельны — скачиваются один раз по URL
- Хранятся в БД (BLOB) — автоудаление при удалении товара
- При изменении `images[]` в API — автоудаление отсутствующих записей

---

## Инкрементальная синхронизация

| Задача | Endpoint | Интервал | Ключ состояния |
|--------|----------|----------|----------------|
| Товары (delta) | goods | 1 мин | `Sync_Goods_LastDelta` |
| Цены | currentprices | 5 мин | `Sync_Prices_LastDelta` |
| Остатки | storegoods | 1 мин | `Sync_Stock_LastDelta` |

> **Преимущество**: Каждый поток использует лёгкие API-модели вместо тяжёлой модели `goods`.
> Изменения цен и остатков имеют свои собственные timestamps (`updated`), что позволяет точно определить изменения.

---

## Конфигурация

```json
"Synchronization": {
  "GoodsDeltaInterval": "00:01:00",
  "FullSyncMaxAge": "1.00:00:00",
  "FullSyncWindowStart": "01:00:00",
  "FullSyncWindowEnd": "05:00:00",
  "FullSyncTimeZoneOffset": 3,
  "PageSize": 250,
  "ForceFullSync": false
}
```

---

## Структура компонентов

```
Services/
├── SyncOrchestrator.cs      # Главный цикл, управление режимами
├── FullSyncRunner.cs        # Полная синхронизация (4 шага)
├── SyncStateRepository.cs   # Работа с sync_state
├── GoodsSyncer.cs           # Товары + изображения (inline)
├── ReferenceSyncer.cs       # Справочники
├── AttributeSyncer.cs       # Атрибуты
└── ImageSyncService.cs      # Скачивание изображений (helper)
```

---

## Ключи состояния (sync_state)

### Полная синхронизация
- `Full_InProgress` — флаг активной синхронизации
- `Full_StartedAt` — время начала
- `Full_CompletedAt` — время завершения
- `Full_*_Complete` — чекпоинты этапов
- `Full_Goods_Page` — текущая страница товаров

### Инкрементальная
- `Sync_Goods_LastDelta` — время последней дельта-синхронизации
