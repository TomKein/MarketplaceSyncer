# Функциональные требования и архитектура

## Общее описание системы
Сервис `MarketplaceSyncer` предназначен для синхронизации товарных запасов, цен и карточек товаров между учетной системой **Business.ru** (источник истины) и различными **маркетплейсами**.

### Основной поток данных (Happy Path)
1.  **Ввод данных**: Продавец создает/обновляет товары, цены и остатки в **Business.ru**.
2.  **Синхронизация (Внутрь)**: Сервис периодически (или по событиям) запрашивает изменения из Business.ru и обновляет **внутреннюю БД**.
    *   Используется фильтрация по дате обновления (`updated[from]`) для эффективности.
3.  **Синхронизация (Наружу)**: Сервис отправляет обновления (цены, остатки, контент карточек, фотографии) на **маркетплейсы**.
4.  **Обработка заказов**:
    *   Мониторинг продаж и резервов на маркетплейсах.
    *   Сохранение заказов и резервов во внутренней бд.
    *   Передача заказов и резервов на создание в Business.ru.
    *   Бизнес.ру сам снижает остаток, что мониторится синхронизацией внутрь.
    *   Штатным механизмом синхронизации, остатки синхронизируются с другими маркетплейсами.
    *   Снятие товаров с продажи на других площадках при исчерпании стока (предотвращение Double Sales).

## Интеграции

### Источник истины
*   **Business.ru ((Class365)**:
    *   API: `https://api-online.class365.ru/api-polnoe/vvedenie_v_api_biznesru/228`
    *   Функции: Каталог товаров, цены, складской учет, резервирование, продажи.

### Маркетплейсы
1.  **Ozon** (Priority 1):
    *   API: `https://seller-edu.ozon.ru/api-ozon/how-to-api`
2.  **Wildberries (WB)**
3.  **Yandex.Market**
4.  **Avito**
    *   Особенность: Сложная система категорий. Планируется использование AI (Gemini Flash) для авто-классификации.
5.  **Drom**
    *   Особенность: Отсутствие публичного API. Использование WebDriver/Selenium (headless).
6.  **VK.com**
7.  **MegaMarket**
8.  **izap24**

## Ключевые проблемы (Legacy) для решения
1.  **Двойные продажи (Double Sales)**: Сбои или задержки синхронизации остатков приводят к продаже отсутствующего товара.
2.  **Задержки обновления контента**: Информация в карточках обновляется нестабильно.
3.  **Разрозненность форматов**: У каждой площадки свои требования к оформлению и структуре категорий.
4.  **Сложность категоризации**: Трудоемкий маппинг категорий (особенно Авито).
5.  **Ценообразование**:
    *   На разных маркетплейсах применяются различные наценки и правила формирования конечной цены.
    *   Правила сложные, требуют переноса логики из Legacy и актуализации с клиентом.

---
## Анализ функциональности Legacy (Selen)

В ходе анализа устаревшего проекта (`Legacy/Selen`) выявлен следующий список реализованных функций и особенностей, которые необходимо учесть (или переосмыслить) в новой системе:

### Реализованные интеграции (Legacy)
*   Business.ru (Class365)
*   Ozon, WB, YandexMarket, Avito, Drom, MegaMarket, VK, Izap24
*   *Не упомянутые пользователем, но присутствующие в коде*: `GdeRu`, `Kupiprodai`, `Satom`, `YoulaXml` (возможно, мертвый код, но стоит проверить актуальность).

### Скрытая бизнес-логика и "Хаки"
1.  **Workaround для обновления цен Business.ru**:
    *   Обнаружен метод `UpdatePrices`, который меняет цену на +0.01 и обратно. Комментарий в коде: *"костыль из-за бага бизнес.ру, убрать когда решится проблема назначения цен"*. С учетом качества кода легаси проекта, его программист мог просто не разобраться в механиках.
2.  **Сложная работа с резервами**:
    *   Метод `CheckReserve` выполняет манипуляции с реализациями: снимает проведение, меняет ответственного сотрудника, проводит обратно. Вероятно, это связано с особенностями учета продаж конкретными менеджерами.
3.  **Обработка дублей имен**:
    *   Метод `CheckDubles` содержит сложную логику переименования товаров с добавлением точек, пробелов и апострофов (`'`, `` ` ``) для обеспечения уникальности имен, если система требует уникальности, а товары фактически одинаковы.
    *   *В новой системе стоит избегать этого через правильное использование ID или артикулов.*
4.  **Очистка и нормализация данных**:
    *   `CheckMultipleApostrophe`: удаление множественных апострофов.
    *   `PartsCorrection` / `CheckGrammarOfTitlesAndDescriptions`: очистка артикулов и названий от лишних символов, проверка грамматики.
    *   `ClearOldUrls`: удаление ссылок на товары (Drom/VK/Ozon), если товар в архиве, копия или без остатков.
5.  **Авто-восстановление токенов**:
    *   Реализован механизм `RepairAsync` для переполучения токена Business.ru при ошибках или таймаутах (MD5 подпись запроса).
6.  **Управление архивом**:
    *   `CheckArhiveStatus`: Автоматическое разархивирование товара в Business.ru, если у него появился положительный остаток (`Amount > 0`).

### Структура данных (Legacy observation)
*   Используются понятия: `SalePrice` (Розничная/Отпускная), `BuyPrice` (Закупочная), `OrderStatuses`, `OrderSources`, `GoodGroups`.
*   Синхронизация групп товаров (`GetBusGroupsAsync`).
