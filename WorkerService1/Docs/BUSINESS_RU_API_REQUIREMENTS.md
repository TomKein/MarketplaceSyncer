# Business.ru API: Системные требования и Протокол (369)

## 1. Базовые параметры
- **Base URL:** `https://online.business.ru/api/rest/`
- **Формат данных:** JSON (обязательное расширение `.json` в конце эндпоинта).
- **Кодировка:** UTF-8 (для всех запросов, кроме `repair.json`, где используется ASCII).

## 2. Авторизация и Безопасность
Для каждого запроса требуются два ключевых параметра подписи: `app_id` и `app_psw`.

### Алгоритм формирования подписи (app_psw):
1. **Сортировка:** Все параметры запроса (кроме самой подписи) должны быть отсортированы по ключам в лексикографическом порядке (PHP `ksort`).
2. **Конкатенация:** `MD5_Hash = MD5(token + secret + sorted_query_string)`.
    - `token`: Текущий сессионный токен.
    - `secret`: Секретный ключ приложения.
    - `sorted_query_string`: Параметры в формате `key1=val1&key2=val2` (без экранирования символов при расчете хеша!).
3. **Регистр:** Хеш MD5 должен быть в нижнем регистре.

## 3. Сессия и Токен (repair.json)
Токен имеет ограниченный срок жизни. Если API возвращает `401` или `403`, нужно вызвать `repair.json`.
- **Особенность repair:** При расчете подписи для этого метода используется `MD5(secret + query_string)` (без токена).
- **Сортировка:** В некоторых реализациях для `repair` используется стандартная Ordinal сортировка.

## 4. Лимиты и Throttling
- **request_count:** Поле в ответе API, показывающее количество запросов, сделанных приложением за последние 5 минут.
- **Ограничение:** При превышении лимита (зависит от тарифа, обычно около 500 запросов за 5 минут) API возвращает ошибку "Превышение лимита".
- **Рекомендация:** Реализовать задержку между запросами: `delay = request_count * 3` (в миллисекундах).

## 5. Методы и Передача параметров
- **GET/DELETE:** Параметры передаются в QueryString.
- **POST/PUT:** Параметры передаются в теле запроса в формате `application/x-www-form-urlencoded`.
- **Экранирование:** Все значения в финальном URL/теле должны быть экранированы (URL Encoded), при этом hex-коды должны быть в ВЕРХНЕМ регистре (например, `%2A`, а не `%2a`).

## 6. Формат ответов
Все ответы оборачиваются в стандартный конверт:
- `status`: "ok" или "error".
- `result`: Данные запроса (массив или объект).
- `request_count`: Счетчик запросов.
- `token`: Новый токен (если применимо).