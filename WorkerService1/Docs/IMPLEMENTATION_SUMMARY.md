# –†–µ–∞–ª–∏–∑–∞—Ü–∏—è —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏ —Ü–µ–Ω Business.ru

## ‚úÖ –í—ã–ø–æ–ª–Ω–µ–Ω–Ω—ã–µ –∑–∞–¥–∞—á–∏

### 1. –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞ –ë–î (PostgreSQL)
–°–æ–∑–¥–∞–Ω–∞ –ø–æ–ª–Ω–∞—è —Å—Ö–µ–º–∞ —Å 7 —Ç–∞–±–ª–∏—Ü–∞–º–∏:
- **businesses** - —Å–ø—Ä–∞–≤–æ—á–Ω–∏–∫ –æ—Ä–≥–∞–Ω–∏–∑–∞—Ü–∏–π Business.ru
- **goods** - —Ç–æ–≤–∞—Ä—ã —Å –ø—Ä–∏–≤—è–∑–∫–æ–π –∫ –æ—Ä–≥–∞–Ω–∏–∑–∞—Ü–∏–∏
- **price_types** - —Ç–∏–ø—ã —Ü–µ–Ω (–†–æ–∑–Ω–∏—á–Ω–∞—è, –û–ø—Ç–æ–≤–∞—è)
- **price_lists** - –ø—Ä–∞–π—Å-–ª–∏—Å—Ç—ã
- **good_prices** ‚≠ê - —Ü–µ–Ω—ã —Ç–æ–≤–∞—Ä–æ–≤ (–∫–ª—é—á–µ–≤–∞—è —Ç–∞–±–ª–∏—Ü–∞)
- **price_update_logs** - –∂—É—Ä–Ω–∞–ª –∞—É–¥–∏—Ç–∞ –∏–∑–º–µ–Ω–µ–Ω–∏–π
- **sync_sessions** - —Å–µ—Å—Å–∏–∏ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏

### 2. –ú–∏–≥—Ä–∞—Ü–∏–∏ FluentMigrator
`Migration_001_InitialSchema.cs` - —Å–æ–∑–¥–∞–µ—Ç –≤—Å–µ —Ç–∞–±–ª–∏—Ü—ã —Å –∏–Ω–¥–µ–∫—Å–∞–º–∏, –≤–Ω–µ—à–Ω–∏–º–∏ –∫–ª—é—á–∞–º–∏ –∏ –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è–º–∏

### 3. –ú–æ–¥–µ–ª–∏ Linq2Db
–°–æ–∑–¥–∞–Ω—ã –º–æ–¥–µ–ª–∏ –¥–ª—è –≤—Å–µ—Ö —Ç–∞–±–ª–∏—Ü –≤ `Data/Models/`:
- Business, Good, PriceType, PriceList
- GoodPrice (—Å –∑–∞—â–∏—Ç–æ–π –æ—Ç –ø–æ–≤—Ç–æ—Ä–Ω–æ–≥–æ –ø–æ–≤—ã—à–µ–Ω–∏—è)
- PriceUpdateLog, SyncSession

### 4. –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è —á–µ—Ä–µ–∑ IOptions
- **BusinessRuOptions** - –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ API (AppId, Secret, BaseUrl, –ª–∏–º–∏—Ç—ã)
- **PriceSyncOptions** - –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏ (–Ω–∞—Ü–µ–Ω–∫–∞ 15%, –æ–∫—Ä—É–≥–ª–µ–Ω–∏–µ –¥–æ 50 —Ä—É–±, —Ä–∞–∑–º–µ—Ä –±–∞—Ç—á–∞ 100)

### 5. –ë–∏–∑–Ω–µ—Å-–ª–æ–≥–∏–∫–∞
**PriceSyncService** —Ä–µ–∞–ª–∏–∑—É–µ—Ç –ø–æ–ª–Ω—ã–π —Ü–∏–∫–ª:
1. –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –æ—Ä–≥–∞–Ω–∏–∑–∞—Ü–∏–∏ –≤ –ë–î
2. –°–æ–∑–¥–∞–Ω–∏–µ —Å–µ—Å—Å–∏–∏ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏
3. –ó–∞–≥—Ä—É–∑–∫–∞ —Å–ø—Ä–∞–≤–æ—á–Ω–∏–∫–æ–≤ (—Ç–∏–ø—ã —Ü–µ–Ω, –ø—Ä–∞–π—Å-–ª–∏—Å—Ç—ã)
4. –ó–∞–≥—Ä—É–∑–∫–∞ —Ç–æ–≤–∞—Ä–æ–≤ —Å –ø–∞–≥–∏–Ω–∞—Ü–∏–µ–π (page-based)
5. –ó–∞–≥—Ä—É–∑–∫–∞ —Ü–µ–Ω —Å –ø–∞–≥–∏–Ω–∞—Ü–∏–µ–π (offset-based)
6. –†–∞—Å—á–µ—Ç –Ω–æ–≤—ã—Ö —Ü–µ–Ω: `price * 1.15` ‚Üí –æ–∫—Ä—É–≥–ª–µ–Ω–∏–µ –¥–æ 50 —Ä—É–±
7. –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Ü–µ–Ω –≤ Business.ru –ø–æ—Ä—Ü–∏—è–º–∏ –ø–æ 100
8. –ó–∞–≤–µ—Ä—à–µ–Ω–∏–µ —Å–µ—Å—Å–∏–∏ —Å –ø–æ–¥—Å—á–µ—Ç–æ–º —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏

### 6. –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å Business.ru API
–ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–π `BusinessRuClient` —Å:
- Rate limiting (500 –∑–∞–ø—Ä–æ—Å–æ–≤ –∑–∞ 5 –º–∏–Ω—É—Ç)
- Retry —Å —ç–∫—Å–ø–æ–Ω–µ–Ω—Ü–∏–∞–ª—å–Ω–æ–π –∑–∞–¥–µ—Ä–∂–∫–æ–π
- –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫

### 7. –ó–∞—â–∏—Ç–∞ –æ—Ç –ø–æ–≤—Ç–æ—Ä–Ω–æ–≥–æ –ø–æ–≤—ã—à–µ–Ω–∏—è
–î–≤–æ–π–Ω–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ –ø–µ—Ä–µ–¥ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ–º:
```csharp
if (!is_processed && Math.Abs(current_price - calculated_price) > 0.01)
{
    // –ú–æ–∂–Ω–æ –æ–±–Ω–æ–≤–ª—è—Ç—å
}
```

## üìÅ –°—Ç—Ä—É–∫—Ç—É—Ä–∞ –ø—Ä–æ–µ–∫—Ç–∞

```
WorkerService1/
‚îú‚îÄ‚îÄ Configuration/
‚îÇ   ‚îú‚îÄ‚îÄ BusinessRuOptions.cs
‚îÇ   ‚îî‚îÄ‚îÄ PriceSyncOptions.cs
‚îú‚îÄ‚îÄ Data/
‚îÇ   ‚îú‚îÄ‚îÄ Models/
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ Business.cs
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ Good.cs
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ PriceType.cs
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ PriceList.cs
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ GoodPrice.cs
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ PriceUpdateLog.cs
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ SyncSession.cs
‚îÇ   ‚îî‚îÄ‚îÄ AppDbConnection.cs
‚îú‚îÄ‚îÄ Migrations/
‚îÇ   ‚îî‚îÄ‚îÄ Migration_001_InitialSchema.cs
‚îú‚îÄ‚îÄ Services/
‚îÇ   ‚îú‚îÄ‚îÄ IPriceSyncService.cs
‚îÇ   ‚îú‚îÄ‚îÄ PriceSyncService.cs
‚îÇ   ‚îî‚îÄ‚îÄ PriceCalculator.cs
‚îú‚îÄ‚îÄ BusinessRuModels.cs (—Ä–∞—Å—à–∏—Ä–µ–Ω –Ω–æ–≤—ã–º–∏ –º–æ–¥–µ–ª—è–º–∏)
‚îú‚îÄ‚îÄ Worker.cs (–æ–±–Ω–æ–≤–ª–µ–Ω –¥–ª—è –∑–∞–ø—É—Å–∫–∞ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏)
‚îú‚îÄ‚îÄ Program.cs (–Ω–∞—Å—Ç—Ä–æ–π–∫–∞ DI –∏ –º–∏–≥—Ä–∞—Ü–∏–π)
‚îî‚îÄ‚îÄ appsettings.json (–∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è —Å XXXXX)
```

## üöÄ –ó–∞–ø—É—Å–∫

### 1. –ó–∞–ø–æ–ª–Ω–∏—Ç—å –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –≤ appsettings.json:
```json
{
  "BusinessRu": {
    "BaseUrl": "https://action_XXXXX.business.ru/api/rest/",
    "OrganizationId": "XXXXX",
    "AppId": "XXXXX",
    "Secret": "XXXXX"
  },
  "ConnectionStrings": {
    "DefaultConnection": "Host=...;Database=...;Username=...;Password=..."
  }
}
```

### 2. –ó–∞–ø—É—Å—Ç–∏—Ç—å Worker:
```bash
cd WorkerService1
dotnet run
```

### 3. –ü—Ä–æ—Ü–µ—Å—Å –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è:
- ‚úÖ –ú–∏–≥—Ä–∞—Ü–∏–∏ –ë–î –∑–∞–ø—É—Å–∫–∞—é—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –ø—Ä–∏ —Å—Ç–∞—Ä—Ç–µ
- ‚úÖ Worker –∑–∞–ø—É—Å–∫–∞–µ—Ç —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—é –æ–¥–∏–Ω —Ä–∞–∑
- ‚úÖ –õ–æ–≥–∏ –ø–∏—à—É—Ç—Å—è –≤ –∫–æ–Ω—Å–æ–ª—å
- ‚úÖ –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç—Å—è –≤ —Ç–∞–±–ª–∏—Ü–µ `sync_sessions`

## üìä –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥

### –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø—Ä–æ–≥—Ä–µ—Å—Å–∞ –≤ –ë–î:
```sql
-- –¢–µ–∫—É—â–∞—è —Å–µ—Å—Å–∏—è
SELECT * FROM sync_sessions ORDER BY started_at DESC LIMIT 1;

-- –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ —Ü–µ–Ω
SELECT 
    COUNT(*) as total,
    COUNT(*) FILTER (WHERE is_processed) as processed,
    COUNT(*) FILTER (WHERE calculated_price IS NOT NULL) as calculated
FROM good_prices;

-- –ü–æ—Å–ª–µ–¥–Ω–∏–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è
SELECT * FROM price_update_logs ORDER BY created_at DESC LIMIT 10;
```

## üéØ –ö–ª—é—á–µ–≤—ã–µ –æ—Å–æ–±–µ–Ω–Ω–æ—Å—Ç–∏

### –ü—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å
- ‚úÖ Batch –æ–ø–µ—Ä–∞—Ü–∏–∏ (–ø–æ 100 –∑–∞–ø–∏—Å–µ–π)
- ‚úÖ –ò–∑–±–µ–≥–∞–Ω–∏–µ –¥–ª–∏–Ω–Ω—ã—Ö —Ü–∏–∫–ª–æ–≤
- ‚úÖ Rate limiting –¥–ª—è API
- ‚úÖ –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –∫–∞–∂–¥—ã–µ 1000/5000 –∑–∞–ø–∏—Å–µ–π

### –ù–∞–¥–µ–∂–Ω–æ—Å—Ç—å
- ‚úÖ –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –æ–±–µ–∏—Ö —Ü–µ–Ω (original –∏ calculated)
- ‚úÖ –ó–∞—â–∏—Ç–∞ –æ—Ç –ø–æ–≤—Ç–æ—Ä–Ω–æ–≥–æ –ø–æ–≤—ã—à–µ–Ω–∏—è —á–µ—Ä–µ–∑ —Ñ–ª–∞–≥ `is_processed`
- ‚úÖ Retry –ø—Ä–∏ –æ—à–∏–±–∫–∞—Ö API
- ‚úÖ –ü–æ–ª–Ω—ã–π –∞—É–¥–∏—Ç –≤ `price_update_logs`

### –ú–∞—Å—à—Ç–∞–±–∏—Ä—É–µ–º–æ—Å—Ç—å
- ‚úÖ –ü–æ–¥–¥–µ—Ä–∂–∫–∞ –º–Ω–æ–∂–µ—Å—Ç–≤–µ–Ω–Ω—ã—Ö –æ—Ä–≥–∞–Ω–∏–∑–∞—Ü–∏–π —á–µ—Ä–µ–∑ —Ç–∞–±–ª–∏—Ü—É `businesses`
- ‚úÖ –ì–æ—Ç–æ–≤–Ω–æ—Å—Ç—å –∫ –¥–æ–±–∞–≤–ª–µ–Ω–∏—é –º–∞—Ä–∫–µ—Ç–ø–ª–µ–π—Å–æ–≤
- ‚úÖ –ì–∏–±–∫–∞—è –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è —á–µ—Ä–µ–∑ IOptions

## üìù –§–æ—Ä–º—É–ª–∞ —Ä–∞—Å—á–µ—Ç–∞ —Ü–µ–Ω—ã

```csharp
newPrice = Math.Round(originalPrice * 1.15 / 50) * 50
```

–ü—Ä–∏–º–µ—Ä:
- 1000 —Ä—É–± ‚Üí 1000 * 1.15 = 1150 ‚Üí –æ–∫—Ä—É–≥–ª–µ–Ω–∏–µ ‚Üí **1150 —Ä—É–±**
- 1234 —Ä—É–± ‚Üí 1234 * 1.15 = 1419.1 ‚Üí –æ–∫—Ä—É–≥–ª–µ–Ω–∏–µ ‚Üí **1400 —Ä—É–±**
- 9876 —Ä—É–± ‚Üí 9876 * 1.15 = 11357.4 ‚Üí –æ–∫—Ä—É–≥–ª–µ–Ω–∏–µ ‚Üí **11350 —Ä—É–±**

## ‚ö†Ô∏è –í–∞–∂–Ω–æ

1. **–ü–µ—Ä–µ–¥ –ø–µ—Ä–≤—ã–º –∑–∞–ø—É—Å–∫–æ–º** –∑–∞–ø–æ–ª–Ω–∏—Ç–µ –≤—Å–µ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã –≤ `appsettings.json`
2. **–ë–î –¥–æ–ª–∂–Ω–∞ –±—ã—Ç—å –¥–æ—Å—Ç—É–ø–Ω–∞** - –º–∏–≥—Ä–∞—Ü–∏–∏ —Å–æ–∑–¥–∞–¥—É—Ç —Ç–∞–±–ª–∏—Ü—ã –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏
3. **Worker –∑–∞–ø—É—Å–∫–∞–µ—Ç—Å—è –æ–¥–∏–Ω —Ä–∞–∑** - –¥–ª—è –ø–æ–≤—Ç–æ—Ä–Ω–æ–≥–æ –∑–∞–ø—É—Å–∫–∞ –ø–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏—Ç–µ –ø—Ä–æ—Ü–µ—Å—Å
4. **–ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ª–æ–≥–∏** –Ω–∞ –Ω–∞–ª–∏—á–∏–µ –æ—à–∏–±–æ–∫
5. **–ü—Ä–æ–≤–µ—Ä—å—Ç–µ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É** –≤ —Ç–∞–±–ª–∏—Ü–µ `sync_sessions`

## üîß –°–ª–µ–¥—É—é—â–∏–µ —à–∞–≥–∏ (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)

1. –î–æ–±–∞–≤–∏—Ç—å CLI –ø–∞—Ä–∞–º–µ—Ç—Ä—ã –¥–ª—è —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è (--reset-processed, --dry-run)
2. –î–æ–±–∞–≤–∏—Ç—å email/webhook —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –æ –∑–∞–≤–µ—Ä—à–µ–Ω–∏–∏
3. –î–æ–±–∞–≤–∏—Ç—å dashboard –¥–ª—è –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞
4. –ò–Ω—Ç–µ–≥—Ä–∏—Ä–æ–≤–∞—Ç—å —Å –º–∞—Ä–∫–µ—Ç–ø–ª–µ–π—Å–∞–º–∏ (Ozon, Wildberries –∏ —Ç.–¥.)
