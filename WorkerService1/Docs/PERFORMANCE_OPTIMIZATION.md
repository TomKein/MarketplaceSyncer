# –û–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏

## üêå –ü—Ä–æ–±–ª–µ–º—ã –î–û –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏

### 1. –ú–Ω–æ–∂–µ—Å—Ç–≤–µ–Ω–Ω—ã–µ –∑–∞–ø—Ä–æ—Å—ã –∫ –ë–î –≤ —Ü–∏–∫–ª–µ
**–ü—Ä–æ–±–ª–µ–º–∞:** –î–ª—è –∫–∞–∂–¥–æ–≥–æ —Ç–æ–≤–∞—Ä–∞/—Ü–µ–Ω—ã –¥–µ–ª–∞–ª—Å—è –æ—Ç–¥–µ–ª—å–Ω—ã–π `FirstOrDefaultAsync`
```csharp
// –ü–õ–û–•–û: 14000+ –∑–∞–ø—Ä–æ—Å–æ–≤ –∫ –ë–î!
foreach (var g in response) {
    var existingGood = await _db.Goods
        .FirstOrDefaultAsync(gd => gd.ExternalId == g.Id);
}
```

**–†–µ–∑—É–ª—å—Ç–∞—Ç:** ~30 –º–∏–Ω—É—Ç –Ω–∞ 14000 —Ç–æ–≤–∞—Ä–æ–≤ = ~130ms –Ω–∞ —Ç–æ–≤–∞—Ä

### 2. –û—Ç—Å—É—Ç—Å—Ç–≤–∏–µ –≤–æ–∑–æ–±–Ω–æ–≤–ª–µ–Ω–∏—è
**–ü—Ä–æ–±–ª–µ–º–∞:** –ü—Ä–∏ –ø—Ä–µ—Ä—ã–≤–∞–Ω–∏–∏ –ø—Ä–æ—Ü–µ—Å—Å –Ω–∞—á–∏–Ω–∞–ª—Å—è —Å –Ω–∞—á–∞–ª–∞
- –ü–æ—Ç–µ—Ä—è –ø—Ä–æ–≥—Ä–µ—Å—Å–∞
- –ù–µ–≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç—å –æ—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –∏ –ø—Ä–æ–¥–æ–ª–∂–∏—Ç—å

---

## ‚ö° –†–µ—à–µ–Ω–∏—è –ü–û–°–õ–ï –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏

### 1. Batch-–∑–∞–≥—Ä—É–∑–∫–∞ —Å—É—â–µ—Å—Ç–≤—É—é—â–∏—Ö –∑–∞–ø–∏—Å–µ–π

**–î–û:**
```csharp
foreach (var g in response) {
    var existingGood = await _db.Goods
        .FirstOrDefaultAsync(gd => gd.ExternalId == g.Id); // 250 –∑–∞–ø—Ä–æ—Å–æ–≤!
}
```

**–ü–û–°–õ–ï:**
```csharp
// –ó–∞–≥—Ä—É–∂–∞–µ–º –≤—Å–µ external_id –æ–¥–Ω–∏–º –∑–∞–ø—Ä–æ—Å–æ–º
var externalIds = response.Select(r => r.Id).ToList();
var existingGoods = await _db.Goods
    .Where(g => g.BusinessId == _businessId && externalIds.Contains(g.ExternalId))
    .ToDictionaryAsync(g => g.ExternalId); // 1 –∑–∞–ø—Ä–æ—Å!

foreach (var g in response) {
    if (existingGoods.TryGetValue(g.Id, out var existingGood)) {
        // –æ–±–Ω–æ–≤–ª—è–µ–º
    }
}
```

**–£—Å–∫–æ—Ä–µ–Ω–∏–µ:** 250 –∑–∞–ø—Ä–æ—Å–æ–≤ ‚Üí 1 –∑–∞–ø—Ä–æ—Å = **~250x –±—ã—Å—Ç—Ä–µ–µ**

### 2. –ö—ç—à–∏—Ä–æ–≤–∞–Ω–∏–µ —Å–ø—Ä–∞–≤–æ—á–Ω–∏–∫–æ–≤

**–î–û:**
```csharp
foreach (var price in response) {
    var good = await _db.Goods.FirstOrDefaultAsync(...); // –∑–∞–ø—Ä–æ—Å
    var priceList = await _db.PriceLists.FirstOrDefaultAsync(...); // –µ—â–µ –∑–∞–ø—Ä–æ—Å
}
```

**–ü–û–°–õ–ï:**
```csharp
// –ó–∞–≥—Ä—É–∂–∞–µ–º –≤—Å–µ —Å–ø—Ä–∞–≤–æ—á–Ω–∏–∫–∏ –æ–¥–∏–Ω —Ä–∞–∑
var goodsCache = await _db.Goods
    .ToDictionaryAsync(g => g.ExternalId, g => g.Id);
var priceListsCache = await _db.PriceLists
    .ToDictionaryAsync(pl => pl.ExternalId);

foreach (var price in response) {
    if (goodsCache.TryGetValue(price.GoodId, out var goodId)) {
        // –∏—Å–ø–æ–ª—å–∑—É–µ–º –∫—ç—à - –±–µ–∑ –∑–∞–ø—Ä–æ—Å–∞ –∫ –ë–î
    }
}
```

**–£—Å–∫–æ—Ä–µ–Ω–∏–µ:** 2 –∑–∞–ø—Ä–æ—Å–∞ –Ω–∞ –∫–∞–∂–¥—É—é —Ü–µ–Ω—É ‚Üí 2 –∑–∞–ø—Ä–æ—Å–∞ –Ω–∞ –≤–µ—Å—å –±–∞—Ç—á

### 3. –í–æ–∑–æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –ø–æ—Å–ª–µ –ø—Ä–µ—Ä—ã–≤–∞–Ω–∏—è

#### LoadGoodsAsync:
```csharp
// –ü—Ä–æ–≤–µ—Ä—è–µ–º, –µ—Å—Ç—å –ª–∏ —É–∂–µ –∑–∞–≥—Ä—É–∂–µ–Ω–Ω—ã–µ —Ç–æ–≤–∞—Ä—ã
var existingCount = await _db.Goods
    .Where(g => g.BusinessId == _businessId)
    .CountAsync();

if (existingCount > 0) {
    _logger.LogInformation("Found {Count} existing goods, skipping reload", existingCount);
    return; // –ü—Ä–æ–ø—É—Å–∫–∞–µ–º –∑–∞–≥—Ä—É–∑–∫—É —Ç–æ–≤–∞—Ä–æ–≤
}
```

#### LoadPricesAsync:
```csharp
// –û–ø—Ä–µ–¥–µ–ª—è–µ–º offset –¥–ª—è –ø—Ä–æ–¥–æ–ª–∂–µ–Ω–∏—è
var lastLoadedCount = await _db.GoodPrices
    .Where(gp => gp.BusinessId == _businessId)
    .CountAsync();

if (lastLoadedCount > 0) {
    _logger.LogInformation("Found {Count} existing prices, resuming from offset {Offset}", 
        lastLoadedCount, lastLoadedCount);
    offset = lastLoadedCount; // –ü—Ä–æ–¥–æ–ª–∂–∞–µ–º —Å –ø–æ—Å–ª–µ–¥–Ω–µ–≥–æ –º–µ—Å—Ç–∞
}
```

**–ü—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞:**
- ‚úÖ –ú–æ–∂–Ω–æ –ø—Ä–µ—Ä–≤–∞—Ç—å –ø—Ä–æ—Ü–µ—Å—Å Ctrl+C
- ‚úÖ –ü—Ä–∏ –ø–æ–≤—Ç–æ—Ä–Ω–æ–º –∑–∞–ø—É—Å–∫–µ –ø—Ä–æ–¥–æ–ª–∂–∏—Ç —Å —Ç–æ–≥–æ –º–µ—Å—Ç–∞, –≥–¥–µ –æ—Å—Ç–∞–Ω–æ–≤–∏–ª—Å—è
- ‚úÖ –ù–µ —Ç–µ—Ä—è–µ—Ç—Å—è –ø—Ä–æ–≥—Ä–µ—Å—Å

### 4. –£–¥–∞–ª–µ–Ω–∏–µ –ª–∏—à–Ω–∏—Ö –∑–∞–¥–µ—Ä–∂–µ–∫

**–î–û:** –ú–Ω–æ–∂–µ—Å—Ç–≤–æ `Thread.Sleep` –∏ `Task.Delay` –≤ –ª–µ–≥–∞—Å–∏ –∫–æ–¥–µ
**–ü–û–°–õ–ï:** –¢–æ–ª—å–∫–æ RateLimiter –∫–æ–Ω—Ç—Ä–æ–ª–∏—Ä—É–µ—Ç –∑–∞–¥–µ—Ä–∂–∫–∏ –º–µ–∂–¥—É –∑–∞–ø—Ä–æ—Å–∞–º–∏

---

## üìä –û–∂–∏–¥–∞–µ–º—ã–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã

### –ó–∞–≥—Ä—É–∑–∫–∞ —Ç–æ–≤–∞—Ä–æ–≤ (14000 —à—Ç)
- **–î–û:** ~30 –º–∏–Ω—É—Ç (130ms/—Ç–æ–≤–∞—Ä)
- **–ü–û–°–õ–ï:** ~3-5 –º–∏–Ω—É—Ç (15-20ms/—Ç–æ–≤–∞—Ä)
- **–£—Å–∫–æ—Ä–µ–Ω–∏–µ:** ~6-10x

### –ó–∞–≥—Ä—É–∑–∫–∞ —Ü–µ–Ω (–ø—Ä–µ–¥–ø–æ–ª–æ–∂–∏–º 50000 —à—Ç)
- **–î–û:** ~2 —á–∞—Å–∞ (150ms/—Ü–µ–Ω–∞)
- **–ü–û–°–õ–ï:** ~10-15 –º–∏–Ω—É—Ç (15-20ms/—Ü–µ–Ω–∞)
- **–£—Å–∫–æ—Ä–µ–Ω–∏–µ:** ~8-12x

### –û–±—â–µ–µ –≤—Ä–µ–º—è –ø–æ–ª–Ω–æ–≥–æ —Ü–∏–∫–ª–∞
- **–î–û:** ~2.5 —á–∞—Å–∞
- **–ü–û–°–õ–ï:** ~15-20 –º–∏–Ω—É—Ç
- **–£—Å–∫–æ—Ä–µ–Ω–∏–µ:** ~7-10x

---

## üîß –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏ (TODO)

### 1. –ù–∞—Å—Ç–æ—è—â–∏–π Bulk Insert —á–µ—Ä–µ–∑ SQL
```csharp
// –í–º–µ—Å—Ç–æ:
foreach (var good in goodsToInsert) {
    await _db.InsertAsync(good);
}

// –ú–æ–∂–Ω–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å:
await _db.ExecuteAsync(@"
    INSERT INTO goods (business_id, external_id, name, ...)
    SELECT * FROM UNNEST(@values)", new { values = goodsToInsert });
```

### 2. –ü–∞—Ä–∞–ª–ª–µ–ª—å–Ω–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞ –±–∞—Ç—á–µ–π
```csharp
var tasks = batches.Select(batch => ProcessBatchAsync(batch));
await Task.WhenAll(tasks);
```

### 3. Connection pooling
–ù–∞—Å—Ç—Ä–æ–∏—Ç—å –≤ connection string:
```
Pooling=true;MinPoolSize=5;MaxPoolSize=20;
```

---

## üéØ –ö–∞–∫ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å

### –ü–µ—Ä–≤—ã–π –∑–∞–ø—É—Å–∫ (–ø–æ–ª–Ω–∞—è –∑–∞–≥—Ä—É–∑–∫–∞):
```bash
dotnet run
```
- –ó–∞–≥—Ä—É–∑–∏—Ç –≤—Å–µ —Ç–æ–≤–∞—Ä—ã
- –ó–∞–≥—Ä—É–∑–∏—Ç –≤—Å–µ —Ü–µ–Ω—ã
- –†–∞—Å—Å—á–∏—Ç–∞–µ—Ç –Ω–æ–≤—ã–µ —Ü–µ–Ω—ã
- –û–±–Ω–æ–≤–∏—Ç –≤ Business.ru

### –ü—Ä–µ—Ä—ã–≤–∞–Ω–∏–µ –∏ –≤–æ–∑–æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ:
1. **Ctrl+C** - –ø—Ä–µ—Ä–≤–∞—Ç—å –ø—Ä–æ—Ü–µ—Å—Å
2. **dotnet run** - –ø—Ä–æ–¥–æ–ª–∂–∏—Ç—å —Å —Ç–æ–≥–æ –º–µ—Å—Ç–∞, –≥–¥–µ –æ—Å—Ç–∞–Ω–æ–≤–∏–ª–∏—Å—å

### –ü–æ–≤—Ç–æ—Ä–Ω—ã–π –∑–∞–ø—É—Å–∫ (—Å–±—Ä–æ—Å):
–ï—Å–ª–∏ –Ω—É–∂–Ω–æ –Ω–∞—á–∞—Ç—å —Å –Ω—É–ª—è, –æ—á–∏—Å—Ç–∏—Ç–µ —Ç–∞–±–ª–∏—Ü—ã:
```sql
TRUNCATE TABLE good_prices CASCADE;
TRUNCATE TABLE goods CASCADE;
```

---

## üìù –õ–æ–≥–∏ –¥–ª—è –æ—Ç–ª–∞–¥–∫–∏

–¢–µ–ø–µ—Ä—å –≤ –ª–æ–≥–∞—Ö –≤–∏–¥–Ω–æ:
```
[INFO] Found 14253 existing goods in DB, skipping reload
[INFO] Found 48932 existing prices, resuming from offset 48932
[INFO] Loaded 1000 goods so far...
[INFO] Loaded 5000 prices so far...
```

---

## ‚ö†Ô∏è –í–∞–∂–Ω—ã–µ –∑–∞–º–µ—á–∞–Ω–∏—è

### 1. Rate Limiting
RateLimiter –≤—Å—ë –µ—â—ë —Ä–∞–±–æ—Ç–∞–µ—Ç –∏ –∑–∞—â–∏—â–∞–µ—Ç –æ—Ç –ø—Ä–µ–≤—ã—à–µ–Ω–∏—è –ª–∏–º–∏—Ç–æ–≤ API

### 2. –¢—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏
–ö–∞–∂–¥—ã–π –±–∞—Ç—á —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç—Å—è –æ—Ç–¥–µ–ª—å–Ω–æ, –ø–æ—ç—Ç–æ–º—É –ø—Ä–∏ –ø—Ä–µ—Ä—ã–≤–∞–Ω–∏–∏ –Ω–µ —Ç–µ—Ä—è–µ—Ç—Å—è –ø—Ä–æ–≥—Ä–µ—Å—Å

### 3. –ò–¥–µ–º–ø–æ—Ç–µ–Ω—Ç–Ω–æ—Å—Ç—å
–ú–æ–∂–Ω–æ –∑–∞–ø—É—Å–∫–∞—Ç—å –ø—Ä–æ—Ü–µ—Å—Å –º–Ω–æ–≥–æ–∫—Ä–∞—Ç–Ω–æ - –æ–Ω –Ω–µ —Å–æ–∑–¥–∞—Å—Ç –¥—É–±–ª–∏ –±–ª–∞–≥–æ–¥–∞—Ä—è:
- `UNIQUE(business_id, external_id)` –≤ goods
- `UNIQUE(business_id, good_id, price_list_id)` –≤ good_prices

---

## üöÄ –°–ª–µ–¥—É—é—â–∏–µ —à–∞–≥–∏

1. **–¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ** - –∑–∞–ø—É—Å—Ç–∏—Ç—å –Ω–∞ –ø–æ–ª–Ω–æ–º –¥–∞—Ç–∞—Å–µ—Ç–µ
2. **–ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥** - —Å–ª–µ–¥–∏—Ç—å –∑–∞ –≤—Ä–µ–º–µ–Ω–µ–º –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è
3. **–ü—Ä–æ—Ñ–∏–ª–∏—Ä–æ–≤–∞–Ω–∏–µ** - –µ—Å–ª–∏ –≤—Å—ë –µ—â—ë –º–µ–¥–ª–µ–Ω–Ω–æ, –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å dotnet-trace
4. **–î–∞–ª—å–Ω–µ–π—à–∞—è –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è** - —Ä–∞—Å—Å–º–æ—Ç—Ä–µ—Ç—å bulk insert —á–µ—Ä–µ–∑ COPY

**–î–∞—Ç–∞ —Å–æ–∑–¥–∞–Ω–∏—è:** 2025-12-31
**–í–µ—Ä—Å–∏—è:** 1.0
