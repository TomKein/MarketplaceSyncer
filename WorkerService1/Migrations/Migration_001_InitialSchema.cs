using System.Data;
using FluentMigrator;

namespace WorkerService1.Migrations;

[Migration(1L, "Initial schema for Business.ru price synchronization")]
public class Migration_001_InitialSchema : Migration
{
	public override void Up()
	{
		base.Create.Table("businesses").WithColumn("id").AsInt64()
			.PrimaryKey()
			.Identity()
			.WithColumn("external_id")
			.AsString(100)
			.NotNullable()
			.WithColumn("organization_id")
			.AsString(100)
			.NotNullable()
			.WithColumn("name")
			.AsString(500)
			.NotNullable()
			.WithColumn("api_url")
			.AsString(500)
			.NotNullable()
			.WithColumn("app_id")
			.AsString(200)
			.NotNullable()
			.WithColumn("secret_encrypted")
			.AsString(500)
			.NotNullable()
			.WithColumn("is_active")
			.AsBoolean()
			.NotNullable()
			.WithDefaultValue(true)
			.WithColumn("created_at")
			.AsDateTimeOffset()
			.NotNullable()
			.WithDefault(SystemMethods.CurrentUTCDateTime)
			.WithColumn("updated_at")
			.AsDateTimeOffset()
			.NotNullable()
			.WithDefault(SystemMethods.CurrentUTCDateTime);
		base.Create.UniqueConstraint("uk_businesses_external_id").OnTable("businesses").Column("external_id");
		base.Create.Table("goods").WithColumn("id").AsInt64()
			.PrimaryKey()
			.Identity()
			.WithColumn("business_id")
			.AsInt64()
			.NotNullable()
			.WithColumn("external_id")
			.AsString(100)
			.NotNullable()
			.WithColumn("name")
			.AsString(1000)
			.NotNullable()
			.WithColumn("part_number")
			.AsString(200)
			.Nullable()
			.WithColumn("store_code")
			.AsString(200)
			.Nullable()
			.WithColumn("archive")
			.AsBoolean()
			.NotNullable()
			.WithDefaultValue(false)
			.WithColumn("created_at")
			.AsDateTimeOffset()
			.NotNullable()
			.WithDefault(SystemMethods.CurrentUTCDateTime)
			.WithColumn("updated_at")
			.AsDateTimeOffset()
			.NotNullable()
			.WithDefault(SystemMethods.CurrentUTCDateTime)
			.WithColumn("last_synced_at")
			.AsDateTimeOffset()
			.Nullable();
		base.Create.ForeignKey("fk_goods_business_id").FromTable("goods").ForeignColumn("business_id")
			.ToTable("businesses")
			.PrimaryColumn("id")
			.OnDelete(Rule.Cascade);
		base.Create.UniqueConstraint("uk_goods_business_external").OnTable("goods").Columns("business_id", "external_id");
		base.Create.Index("idx_goods_business_id").OnTable("goods").OnColumn("business_id");
		base.Create.Table("price_types").WithColumn("id").AsInt64()
			.PrimaryKey()
			.Identity()
			.WithColumn("business_id")
			.AsInt64()
			.NotNullable()
			.WithColumn("external_id")
			.AsString(100)
			.NotNullable()
			.WithColumn("name")
			.AsString(500)
			.NotNullable()
			.WithColumn("is_sale_price")
			.AsBoolean()
			.NotNullable()
			.WithDefaultValue(false)
			.WithColumn("is_buy_price")
			.AsBoolean()
			.NotNullable()
			.WithDefaultValue(false)
			.WithColumn("created_at")
			.AsDateTimeOffset()
			.NotNullable()
			.WithDefault(SystemMethods.CurrentUTCDateTime)
			.WithColumn("updated_at")
			.AsDateTimeOffset()
			.NotNullable()
			.WithDefault(SystemMethods.CurrentUTCDateTime);
		base.Create.ForeignKey("fk_price_types_business_id").FromTable("price_types").ForeignColumn("business_id")
			.ToTable("businesses")
			.PrimaryColumn("id")
			.OnDelete(Rule.Cascade);
		base.Create.UniqueConstraint("uk_price_types_business_external").OnTable("price_types").Columns("business_id", "external_id");
		base.Create.Table("price_lists").WithColumn("id").AsInt64()
			.PrimaryKey()
			.Identity()
			.WithColumn("business_id")
			.AsInt64()
			.NotNullable()
			.WithColumn("external_id")
			.AsString(100)
			.NotNullable()
			.WithColumn("price_type_id")
			.AsInt64()
			.NotNullable()
			.WithColumn("name")
			.AsString(500)
			.NotNullable()
			.WithColumn("is_active")
			.AsBoolean()
			.NotNullable()
			.WithDefaultValue(true)
			.WithColumn("created_at")
			.AsDateTimeOffset()
			.NotNullable()
			.WithDefault(SystemMethods.CurrentUTCDateTime)
			.WithColumn("updated_at")
			.AsDateTimeOffset()
			.NotNullable()
			.WithDefault(SystemMethods.CurrentUTCDateTime);
		base.Create.ForeignKey("fk_price_lists_business_id").FromTable("price_lists").ForeignColumn("business_id")
			.ToTable("businesses")
			.PrimaryColumn("id")
			.OnDelete(Rule.Cascade);
		base.Create.ForeignKey("fk_price_lists_price_type_id").FromTable("price_lists").ForeignColumn("price_type_id")
			.ToTable("price_types")
			.PrimaryColumn("id")
			.OnDelete(Rule.Cascade);
		base.Create.UniqueConstraint("uk_price_lists_business_external").OnTable("price_lists").Columns("business_id", "external_id");
		base.Create.Index("idx_price_lists_price_type_id").OnTable("price_lists").OnColumn("price_type_id");
		base.Create.Table("good_prices").WithColumn("id").AsInt64()
			.PrimaryKey()
			.Identity()
			.WithColumn("business_id")
			.AsInt64()
			.NotNullable()
			.WithColumn("good_id")
			.AsInt64()
			.NotNullable()
			.WithColumn("price_list_id")
			.AsInt64()
			.NotNullable()
			.WithColumn("external_price_record_id")
			.AsString(100)
			.NotNullable()
			.WithColumn("original_price")
			.AsDecimal(18, 2)
			.NotNullable()
			.WithColumn("calculated_price")
			.AsDecimal(18, 2)
			.Nullable()
			.WithColumn("current_price")
			.AsDecimal(18, 2)
			.NotNullable()
			.WithColumn("price_increase_percent")
			.AsDecimal(5, 2)
			.Nullable()
			.WithColumn("calculation_date")
			.AsDateTimeOffset()
			.Nullable()
			.WithColumn("updated_in_businessru_at")
			.AsDateTimeOffset()
			.Nullable()
			.WithColumn("is_processed")
			.AsBoolean()
			.NotNullable()
			.WithDefaultValue(false)
			.WithColumn("currency_id")
			.AsString(10)
			.Nullable()
			.WithColumn("created_at")
			.AsDateTimeOffset()
			.NotNullable()
			.WithDefault(SystemMethods.CurrentUTCDateTime)
			.WithColumn("updated_at")
			.AsDateTimeOffset()
			.NotNullable()
			.WithDefault(SystemMethods.CurrentUTCDateTime);
		base.Create.ForeignKey("fk_good_prices_business_id").FromTable("good_prices").ForeignColumn("business_id")
			.ToTable("businesses")
			.PrimaryColumn("id")
			.OnDelete(Rule.Cascade);
		base.Create.ForeignKey("fk_good_prices_good_id").FromTable("good_prices").ForeignColumn("good_id")
			.ToTable("goods")
			.PrimaryColumn("id")
			.OnDelete(Rule.Cascade);
		base.Create.ForeignKey("fk_good_prices_price_list_id").FromTable("good_prices").ForeignColumn("price_list_id")
			.ToTable("price_lists")
			.PrimaryColumn("id")
			.OnDelete(Rule.Cascade);
		base.Create.UniqueConstraint("uk_good_prices_business_good_pricelist").OnTable("good_prices").Columns("business_id", "good_id", "price_list_id");
		base.Create.Index("idx_good_prices_is_processed").OnTable("good_prices").OnColumn("is_processed")
			.Ascending()
			.OnColumn("business_id")
			.Ascending();
		base.Create.Index("idx_good_prices_calculation_date").OnTable("good_prices").OnColumn("calculation_date");
		base.Create.Table("price_update_logs").WithColumn("id").AsInt64()
			.PrimaryKey()
			.Identity()
			.WithColumn("good_price_id")
			.AsInt64()
			.NotNullable()
			.WithColumn("old_price")
			.AsDecimal(18, 2)
			.Nullable()
			.WithColumn("new_price")
			.AsDecimal(18, 2)
			.Nullable()
			.WithColumn("action_type")
			.AsString(50)
			.NotNullable()
			.WithColumn("error_message")
			.AsString(4000)
			.Nullable()
			.WithColumn("created_at")
			.AsDateTimeOffset()
			.NotNullable()
			.WithDefault(SystemMethods.CurrentUTCDateTime);
		base.Create.ForeignKey("fk_price_update_logs_good_price_id").FromTable("price_update_logs").ForeignColumn("good_price_id")
			.ToTable("good_prices")
			.PrimaryColumn("id")
			.OnDelete(Rule.Cascade);
		base.Create.Index("idx_price_update_logs_created_at").OnTable("price_update_logs").OnColumn("created_at");
		base.Create.Index("idx_price_update_logs_good_price_id").OnTable("price_update_logs").OnColumn("good_price_id");
		base.Create.Table("sync_sessions").WithColumn("id").AsInt64()
			.PrimaryKey()
			.Identity()
			.WithColumn("business_id")
			.AsInt64()
			.NotNullable()
			.WithColumn("started_at")
			.AsDateTimeOffset()
			.NotNullable()
			.WithDefault(SystemMethods.CurrentUTCDateTime)
			.WithColumn("completed_at")
			.AsDateTimeOffset()
			.Nullable()
			.WithColumn("status")
			.AsString(50)
			.NotNullable()
			.WithColumn("goods_fetched")
			.AsInt32()
			.NotNullable()
			.WithDefaultValue(0)
			.WithColumn("prices_fetched")
			.AsInt32()
			.NotNullable()
			.WithDefaultValue(0)
			.WithColumn("prices_calculated")
			.AsInt32()
			.NotNullable()
			.WithDefaultValue(0)
			.WithColumn("prices_updated")
			.AsInt32()
			.NotNullable()
			.WithDefaultValue(0)
			.WithColumn("errors_count")
			.AsInt32()
			.NotNullable()
			.WithDefaultValue(0)
			.WithColumn("error_details")
			.AsCustom("jsonb")
			.Nullable();
		base.Create.ForeignKey("fk_sync_sessions_business_id").FromTable("sync_sessions").ForeignColumn("business_id")
			.ToTable("businesses")
			.PrimaryColumn("id")
			.OnDelete(Rule.Cascade);
		base.Create.Index("idx_sync_sessions_business_started").OnTable("sync_sessions").OnColumn("business_id")
			.Ascending()
			.OnColumn("started_at")
			.Ascending();
	}

	public override void Down()
	{
		base.Delete.Table("sync_sessions");
		base.Delete.Table("price_update_logs");
		base.Delete.Table("good_prices");
		base.Delete.Table("price_lists");
		base.Delete.Table("price_types");
		base.Delete.Table("goods");
		base.Delete.Table("businesses");
	}
}
