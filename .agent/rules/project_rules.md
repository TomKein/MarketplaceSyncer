---
trigger: always_on
---

# Правила разработки проекта

## 1. Язык и Документация
- **Основной Проект**: `MarketplaceSyncer.Service` является главным проектом. Все изменения по умолчанию вносятся туда, если не указано иное (или `Legacy`).
- **Документация API**: Документация по API Business.ru находится в `Docs\BusinessRuApi`. Если в документации отсутствуют необходимые данные, **агент обязан** запросить у пользователя дополнение документации.
- Все общение, планы реализации (implementation plans), списки задач (task lists), **документация**, комментарии к коду и другие артефакты должны быть на **русском языке**.
- XML-комментарии (`<summary>`), логирование, отчеты — **строго на русском**.
- Никаких эмодзи в комментариях к коду или логах.

## 2. Технологический Стек и Производительность
- **Framework**: .NET 10, C# 14.
- **Библиотеки**: System.Text.Json, Serilog, Linq2Db PostgreSQL, FluentMigrator, xUnit v3, ErrorOr (Result pattern).
- **Даты и Время**: Всегда используйте `DateTimeOffset` вместо `DateTime` для полей даты и времени в моделях и DTO.
- **Business.ru API IDs**: Тип `int` в документации Business.ru соответствует `PHP int` (64-bit), поэтому в C# всегда используйте `long` для ID и ссылок на ID.

## 3. Базы Данных и Миграции
- **Поля Синхронизации**: Все синхронизируемые сущности должны содержать поле `last_synced_at` (типа `DateTimeOffset`) в БД.
- **Новые Сущности**: Создавать новые файлы миграций только для совершенно новых сущностей.
- **Обновления**: НЕ СОЗДАВАЙТЕ последовательные миграции для одной и той же сущности. Изменяйте существующие файлы миграций.
- **Совместимость**: Обратная совместимость не требуется.

## 4. Стиль Кода и Best Practices
- **Primary Constructors**: Используйте первичные конструкторы C# 14 по умолчанию.
- **Namespaces**: Используйте file-scoped namespaces.
- **Типы**: Всегда используйте короткие имена типов и `using`. Не используйте полные имена (FQN), кроме случаев разрешения конфликтов имен (ambiguous types).
- **DTO Naming**: Модели API ответов (DTO) должны иметь суффикс `Response` (например, `GoodResponse`, `StoreResponse`), чтобы избегать конфликтов имен с Entity моделями БД.
- **Обработка Ошибок**: Используйте библиотеку `ErrorOr`.
- **Using Declarations**: Предпочитайте `using declaration` (без фигурных скобок) вместо `using statement`, чтобы уменьшить вложенность и сложность кода.
- **DRY**: Приоритет читаемости и DRY, если это не конфликтует с NativeAOT.
- **JSON Parsing**: Всегда используйте встроенные преобразования `System.Text.Json` и `JsonConverter` для типов (decimal, DateTimeOffset и др.). Избегайте парсинга в `string` с последующим ручным преобразованием.

## 5. Рабочий Процесс (Workflow)
- **Planning**: Анализ, `implementation_plan.md`, утверждение пользователем.
- **Initiation**: Feature-ветки `feature/task-title`.
- **Development**: Commit & Push после каждой собираемой итерации.
- **Completion**: Code Review, Walkthrough, Merge Request.
- **NuGet**: Использовать CPM (`Directory.Packages.props`).
- **Файловые операции**: Приоритет api агента, если нет функционала - powershell. Для переименования или перемещения файлов всегда используйте `git mv` (через терминал) или команды PowerShell `Rename-Item`/`Move-Item`, чтобы сохранить историю Git. Избегайте сочетания `del` + `write_to_file`.
